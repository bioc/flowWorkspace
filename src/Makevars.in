#  GNUMakefile
 
# Just a snippet to stop executing under other make(1) commands
# that won't understand these lines
ifneq (,)
This makefile requires GNU Make.
endif
	
PBBUILD=@PBBUILD@

#if bundled pb is used, set pb lib
ifneq ($(PBBUILD),) 	
pb_lib=libprotobuf.a
PBBUILDDIR = $(PBBUILD)/src/google/protobuf/
pb_objs=$(PBBUILDDIR).libs/*.o $(PBBUILDDIR)stubs/.libs/*.o $(PBBUILDDIR)io/.libs/*.o
endif

CXX_STD = CXX11
PKG_CPPFLAGS =-DROUT @PKG_CPPFLAGS@
PKG_LIBS =${USERLIB} `${R_HOME}/bin/Rscript -e "flowCore:::LdFlags()"` @PKG_LIBS@ 

#expose headers in installed package include folder
USERINCLUDE = $(R_PACKAGE_DIR)/include
USERHEADERDIR = $(USERINCLUDE)/flowWorkspace
USERHEADER = $(USERINCLUDE)/GatingSet.hpp

USERDIR = ${R_PACKAGE_DIR}/lib${R_ARCH}
USERLIB = ${USERDIR}/${pb_lib}
PKGLIB = ${USERDIR}/libflowWorkspace.a

 
all:  $(USERHEADER)	$(SHLIB)

$(SHLIB): $(USERLIB) $(PKGLIB)


#archive pb objects (only executed when pb_lib is set)
$(USERLIB): ${pb_objs}
	mkdir -p "${USERDIR}"
	$(AR) rs "${USERLIB}" ${pb_objs}

#expose static lib for other package to link to 
$(PKGLIB): $(OBJECTS)
	mkdir -p "${USERDIR}"
	$(AR) rs "${PKGLIB}" $(OBJECTS)


#copy the src/include/* to package include
$(USERHEADER): 
	mkdir -p "${USERHEADERDIR}"
	cp include/* ${USERHEADERDIR}
	cp -r @PB_INCLUDE@/google ${USERINCLUDE}
	cp GatingSet.pb.h ${USERINCLUDE} #GatingSet.pb.h is autogenerated by protoc and thus kept at the same folder as GatingSet.proto
 		

.PHONY: 	all clean 

clean:
		rm -f $(OBJECTS) $(SHLIB)
 
